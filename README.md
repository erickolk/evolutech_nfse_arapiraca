# Sistema NFSe Arapiraca

Sistema completo para emiss√£o de Notas Fiscais de Servi√ßos Eletr√¥nicas (NFSe) para o munic√≠pio de Arapiraca/AL.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Instala√ß√£o](#instala√ß√£o)
- [Configura√ß√£o](#configura√ß√£o)
- [Uso B√°sico](#uso-b√°sico)
- [M√≥dulos do Sistema](#m√≥dulos-do-sistema)
- [Modos de Opera√ß√£o](#modos-de-opera√ß√£o)
- [Exemplos de Uso](#exemplos-de-uso)
- [Troubleshooting](#troubleshooting)
- [Estrutura do Projeto](#estrutura-do-projeto)

## üéØ Vis√£o Geral

Este sistema implementa a integra√ß√£o completa com o web service de NFSe da Prefeitura de Arapiraca, seguindo o padr√£o ABRASF. O sistema √© capaz de:

- ‚úÖ Gerar lotes RPS (Recibo Provis√≥rio de Servi√ßos)
- ‚úÖ Construir XML no padr√£o ABRASF
- ‚úÖ Assinar digitalmente os documentos
- ‚úÖ Enviar lotes para o web service
- ‚úÖ Consultar status de processamento
- ‚úÖ Obter NFSe geradas
- ‚úÖ Modo de teste para desenvolvimento

## üöÄ Instala√ß√£o

### Pr√©-requisitos

- Python 3.8+
- Certificado digital A1 (.pfx) para produ√ß√£o

### Passos de Instala√ß√£o

1. **Clone ou baixe o projeto:**
```bash
cd c:\Users\erick\OneDrive\Documentos\SistemaNFS\nfse_arapiraca
```

2. **Crie e ative o ambiente virtual:**
```bash
python -m venv venv
venv\Scripts\activate
```

3. **Instale as depend√™ncias:**
```bash
pip install -r requirements.txt
```

## ‚öôÔ∏è Configura√ß√£o

### Arquivo de Configura√ß√£o

Edite o arquivo `config.py` com suas informa√ß√µes:

```python
# Dados do Prestador
PRESTADOR_CNPJ = "12345678000195"  # Seu CNPJ
PRESTADOR_IM = "123456"            # Inscri√ß√£o Municipal
CODIGO_MUNICIPIO = "2700102"       # C√≥digo de Arapiraca

# Certificado Digital
CERT_PATH = "certs/seu_certificado.pfx"
CERT_PASSWORD = "senha_do_certificado"

# Modos de Opera√ß√£o
TEST_MODE = False           # True para logs detalhados
SKIP_SIGNATURE = True       # True para pular assinatura (teste)
MOCK_WEBSERVICE = True      # True para simular web service
```

### Certificado Digital

Para produ√ß√£o, coloque seu certificado A1 na pasta `certs/`:
```
certs/
‚îî‚îÄ‚îÄ seu_certificado.pfx
```

## üìñ Uso B√°sico

### Processamento Autom√°tico

```python
from orchestrator import process_pending_invoices

# Processar todas as faturas pendentes
resultado = process_pending_invoices()

if resultado['sucesso']:
    print(f"‚úÖ Processamento conclu√≠do!")
    print(f"Protocolo: {resultado['protocolo']}")
    print(f"NFSe geradas: {resultado['nfse_geradas']}")
else:
    print(f"‚ùå Erro: {resultado['erro']}")
```

### Consultas Individuais

```python
from soap_client import check_lote_status, get_lote_results

# Consultar status de um lote
status = check_lote_status("PROTOCOLO_123")
print(f"Status: {status['status_descricao']}")

# Obter resultados finais
resultados = get_lote_results("PROTOCOLO_123")
print(f"NFSe geradas: {len(resultados['nfse_geradas'])}")
```

## üîß M√≥dulos do Sistema

### 1. `orchestrator.py` - Orquestrador Principal
Coordena todo o processo de emiss√£o de NFSe:
- Obt√©m faturas pendentes
- Constr√≥i XML do lote
- Assina digitalmente
- Envia para web service
- Monitora processamento
- Obt√©m resultados

### 2. `data_source.py` - Fonte de Dados
Gerencia os dados dos RPS:
- Obt√©m faturas para processamento
- Gera n√∫meros de lote
- Formata dados no padr√£o esperado

### 3. `xml_builder.py` - Construtor de XML
Constr√≥i XML no padr√£o ABRASF:
- Monta estrutura do lote RPS
- Valida dados obrigat√≥rios
- Gera XML bem formado

### 4. `signer.py` - Assinatura Digital
Assina documentos XML:
- Carrega certificado A1
- Assina XML com padr√£o XMLDSig
- Suporte a modo de teste

### 5. `soap_client.py` - Cliente Web Service
Comunica com web service da prefeitura:
- Envia lotes RPS
- Consulta status
- Obt√©m NFSe geradas
- Trata erros e timeouts

### 6. `config.py` - Configura√ß√µes
Centraliza todas as configura√ß√µes do sistema.

## üéÆ Modos de Opera√ß√£o

### Modo Teste (Desenvolvimento)
```python
# config.py
TEST_MODE = False
SKIP_SIGNATURE = True
MOCK_WEBSERVICE = True
```
- Simula respostas do web service
- Pula assinatura digital
- Ideal para desenvolvimento

### Modo Homologa√ß√£o
```python
# config.py
TEST_MODE = False
SKIP_SIGNATURE = False
MOCK_WEBSERVICE = False
# URLs apontam para homologa√ß√£o
```
- Usa web service de homologa√ß√£o
- Requer certificado v√°lido
- Testa integra√ß√£o real

### Modo Produ√ß√£o
```python
# config.py
TEST_MODE = False
SKIP_SIGNATURE = False
MOCK_WEBSERVICE = False
# URLs apontam para produ√ß√£o
```
- Ambiente de produ√ß√£o
- Gera NFSe reais
- Requer certificado v√°lido

## üí° Exemplos de Uso

### Exemplo 1: Processamento Completo
```python
#!/usr/bin/env python3
from orchestrator import process_pending_invoices
import logging

# Configurar logging
logging.basicConfig(level=logging.INFO)

def main():
    print("üöÄ Iniciando processamento de NFSe...")
    
    resultado = process_pending_invoices()
    
    if resultado['sucesso']:
        print("‚úÖ Sucesso!")
        print(f"   Protocolo: {resultado['protocolo']}")
        print(f"   Dura√ß√£o: {resultado['duracao']:.2f}s")
        print(f"   Etapas: {', '.join(resultado['etapas_concluidas'])}")
        print(f"   NFSe: {resultado['nfse_geradas']}")
    else:
        print("‚ùå Erro no processamento:")
        for erro in resultado['erros']:
            print(f"   - {erro}")

if __name__ == "__main__":
    main()
```

### Exemplo 2: Monitoramento de Lote
```python
from soap_client import check_lote_status
import time

def monitorar_lote(protocolo, max_tentativas=10):
    """Monitora um lote at√© conclus√£o"""
    
    for tentativa in range(1, max_tentativas + 1):
        print(f"Tentativa {tentativa}/{max_tentativas}")
        
        status = check_lote_status(protocolo)
        
        if not status['sucesso']:
            print(f"‚ùå Erro: {status['erro']}")
            break
            
        status_code = status['status']
        status_desc = status['status_descricao']
        
        print(f"Status: {status_code} - {status_desc}")
        
        if status_code == 4:  # Processado
            print("‚úÖ Lote processado com sucesso!")
            break
        elif status_code == 3:  # Erro
            print("‚ùå Lote processado com erro!")
            break
        else:
            print("‚è≥ Aguardando processamento...")
            time.sleep(30)  # Aguarda 30 segundos

# Uso
monitorar_lote("PROTOCOLO_123")
```

### Exemplo 3: Integra√ß√£o com Sistema Pr√≥prio
```python
class NFSeIntegration:
    def __init__(self):
        self.logger = logging.getLogger(__name__)
    
    def processar_faturas_periodo(self, data_inicio, data_fim):
        """Processa faturas de um per√≠odo espec√≠fico"""
        
        # 1. Buscar faturas do seu sistema
        faturas = self.buscar_faturas_periodo(data_inicio, data_fim)
        
        if not faturas:
            self.logger.info("Nenhuma fatura encontrada para o per√≠odo")
            return
        
        # 2. Processar com NFSe
        resultado = process_pending_invoices()
        
        # 3. Atualizar status no seu sistema
        if resultado['sucesso']:
            self.atualizar_status_faturas(faturas, 'PROCESSADO', resultado['protocolo'])
        else:
            self.atualizar_status_faturas(faturas, 'ERRO', None)
        
        return resultado
    
    def buscar_faturas_periodo(self, inicio, fim):
        # Implementar busca no seu banco de dados
        pass
    
    def atualizar_status_faturas(self, faturas, status, protocolo):
        # Implementar atualiza√ß√£o no seu banco de dados
        pass
```

## üîç Troubleshooting

### Problemas Comuns

#### 1. Erro de Certificado
```
Erro: Certificado n√£o encontrado: certs/seu_certificado.pfx
```
**Solu√ß√£o:**
- Verifique se o arquivo .pfx existe na pasta `certs/`
- Confirme se a senha est√° correta em `CERT_PASSWORD`
- Para teste, use `SKIP_SIGNATURE = True`

#### 2. Erro de Conex√£o SOAP
```
Erro: There is no default service defined
```
**Solu√ß√£o:**
- Verifique conectividade com internet
- Confirme URLs do web service em `config.py`
- Para teste, use `MOCK_WEBSERVICE = True`

#### 3. Dados Inv√°lidos
```
Erro: Campo obrigat√≥rio n√£o informado
```
**Solu√ß√£o:**
- Verifique dados em `data_source.py`
- Confirme CNPJ e Inscri√ß√£o Municipal
- Valide estrutura dos dados RPS

#### 4. Timeout na Consulta
```
Erro: Timeout ao consultar status
```
**Solu√ß√£o:**
- Aguarde mais tempo entre consultas
- Verifique se o lote foi realmente enviado
- Consulte logs do web service

### Logs do Sistema

Os logs s√£o salvos em `nfse_orchestrator.log`:

```bash
# Ver logs em tempo real
tail -f nfse_orchestrator.log

# Filtrar erros
grep "ERROR" nfse_orchestrator.log

# Ver √∫ltimas 50 linhas
tail -50 nfse_orchestrator.log
```

### Valida√ß√£o de Configura√ß√£o

```python
def validar_configuracao():
    """Valida configura√ß√£o antes de usar"""
    
    import config
    import os
    
    erros = []
    
    # Validar dados obrigat√≥rios
    if not config.PRESTADOR_CNPJ:
        erros.append("PRESTADOR_CNPJ n√£o configurado")
    
    if not config.PRESTADOR_IM:
        erros.append("PRESTADOR_IM n√£o configurado")
    
    # Validar certificado (se n√£o em modo teste)
    if not config.SKIP_SIGNATURE:
        if not os.path.exists(config.CERT_PATH):
            erros.append(f"Certificado n√£o encontrado: {config.CERT_PATH}")
    
    if erros:
        print("‚ùå Erros de configura√ß√£o:")
        for erro in erros:
            print(f"   - {erro}")
        return False
    
    print("‚úÖ Configura√ß√£o v√°lida!")
    return True

# Usar antes de processar
if validar_configuracao():
    resultado = process_pending_invoices()
```

## üìÅ Estrutura do Projeto

```
nfse_arapiraca/
‚îú‚îÄ‚îÄ üìÑ README.md              # Esta documenta√ß√£o
‚îú‚îÄ‚îÄ üìÑ requirements.txt       # Depend√™ncias Python
‚îú‚îÄ‚îÄ üìÑ config.py             # Configura√ß√µes do sistema
‚îú‚îÄ‚îÄ üìÑ orchestrator.py       # Orquestrador principal
‚îú‚îÄ‚îÄ üìÑ data_source.py        # Fonte de dados RPS
‚îú‚îÄ‚îÄ üìÑ xml_builder.py        # Construtor de XML
‚îú‚îÄ‚îÄ üìÑ signer.py             # Assinatura digital
‚îú‚îÄ‚îÄ üìÑ soap_client.py        # Cliente web service
‚îú‚îÄ‚îÄ üìÑ main.py               # Script principal
‚îú‚îÄ‚îÄ üìÑ nfse_orchestrator.log # Logs do sistema
‚îú‚îÄ‚îÄ üìÅ certs/                # Certificados digitais
‚îú‚îÄ‚îÄ üìÅ venv/                 # Ambiente virtual Python
‚îî‚îÄ‚îÄ üìÅ __pycache__/          # Cache Python
```

## üîÑ Fluxo de Processamento

```mermaid
graph TD
    A[Obter Faturas] --> B[Construir XML]
    B --> C[Assinar XML]
    C --> D[Enviar Lote]
    D --> E[Polling Status]
    E --> F{Status = 4?}
    F -->|N√£o| E
    F -->|Sim| G[Obter Resultados]
    G --> H[NFSe Geradas]
```

## üìû Suporte

Para d√∫vidas ou problemas:

1. **Verifique os logs** em `nfse_orchestrator.log`
2. **Consulte esta documenta√ß√£o**
3. **Teste em modo simulado** primeiro
4. **Valide configura√ß√µes** antes de usar

---

**Sistema NFSe Arapiraca** - Vers√£o 1.0  
Desenvolvido para integra√ß√£o com web service da Prefeitura de Arapiraca/AL# evolutech_nfse_arapiraca
# evolutech_nfse_arapiraca
